<!-- Session Timeout Handler
     Purpose: Auto-logout users after 30 minutes of inactivity
     Include this in the <head> of volunteer and coordinator pages
-->

<script>
    // Configuration
    const SESSION_TIMEOUT_MINUTES = 30;
    const SESSION_TIMEOUT_MS = SESSION_TIMEOUT_MINUTES * 60 * 1000; // Convert to milliseconds
    let sessionTimeoutId = null;
    let warningTimeoutId = null;
    const WARNING_TIME_MS = 2 * 60 * 1000; // Show warning 2 minutes before logout

    function resetSessionTimeout() {
        // Clear existing timeouts
        if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
        if (warningTimeoutId) clearTimeout(warningTimeoutId);

        // Set warning timeout (show 2 minutes before logout)
        warningTimeoutId = setTimeout(() => {
            showSessionWarning();
        }, SESSION_TIMEOUT_MS - WARNING_TIME_MS);

        // Set logout timeout
        sessionTimeoutId = setTimeout(() => {
            logoutUser();
        }, SESSION_TIMEOUT_MS);
    }

    function showSessionWarning() {
        // Create warning modal
        const modal = document.createElement('div');
        modal.id = 'session-warning-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;

        const warningBox = document.createElement('div');
        warningBox.style.cssText = `
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;

        warningBox.innerHTML = `
            <h2 style="margin-top: 0; color: #333;">Your session is about to expire</h2>
            <p style="color: #666; font-size: 16px;">You have been inactive for ${SESSION_TIMEOUT_MINUTES - 2} minutes.</p>
            <p style="color: #666; font-size: 16px; margin-bottom: 24px;">You will be logged out in 2 minutes.</p>
            <div style="display: flex; gap: 12px;">
                <button id="continue-session-btn" style="flex: 1; padding: 12px 24px; background: #4A90E2; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Continue Session</button>
                <button id="logout-now-btn" style="flex: 1; padding: 12px 24px; background: #E46B8C; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Logout Now</button>
            </div>
        `;

        modal.appendChild(warningBox);
        document.body.appendChild(modal);

        // Button handlers
        document.getElementById('continue-session-btn').addEventListener('click', () => {
            modal.remove();
            resetSessionTimeout();
        });

        document.getElementById('logout-now-btn').addEventListener('click', () => {
            logoutUser();
        });
    }

    function logoutUser() {
        // Remove warning modal if it exists
        const modal = document.getElementById('session-warning-modal');
        if (modal) modal.remove();

        // Log out from Django session
        fetch('/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(() => {
            // Redirect to signin page
            window.location.href = '/volunteer/signin/';
        }).catch(() => {
            // If logout fails, still redirect
            window.location.href = '/volunteer/signin/';
        });
    }

    // Activity tracker - reset timeout on user activity
    function setupActivityListeners() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        
        events.forEach(event => {
            document.addEventListener(event, () => {
                resetSessionTimeout();
            }, true); // Use capture phase to catch events even if stopped
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        setupActivityListeners();
        resetSessionTimeout();
    });
</script>
