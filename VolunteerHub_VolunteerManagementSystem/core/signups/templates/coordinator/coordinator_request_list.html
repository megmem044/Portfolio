<!-- File: signups/templates/coordinator/coordinator_request_list.html
     Purpose:
       Coordinator-facing page that lists all volunteer signup requests
       for any event. Requests can be approved or declined and
       coordinators can open the volunteer's profile for review.
       Uses the medium-cerulean coordinator UI theme.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Volunteer Requests</title>

    <style>
        :root {
            /* Blue palette matching coordinator dashboard */
            --bg: #F0F8FF;
            --primary: #4A90E2;
            --primary-dark: #2E5C8A;
            --card: #ffffff;
            --text: #1F3A4D;
            --muted: #6B7C8F;
            --shadow: rgba(74, 144, 226, 0.15);
            --danger: #d9534f;
            --success: #3fae4e;
        }

        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 50px;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            font-size: 22px;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 22px;
            font-weight: 700;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: var(--primary);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s ease;
            border: none;
            cursor: pointer;
        }

        .back-btn:hover {
            background: var(--primary-dark);
            color: white;
        }

        .container {
            width: 94%;
            max-width: 1100px;
            margin: 40px auto;
        }

        .section {
            background: var(--card);
            padding: 28px;
            border-radius: 18px;
            box-shadow: 0 6px 18px var(--shadow);
            margin-bottom: 26px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 18px;
        }

        .request-card {
            background: #f6faff;
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 18px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: box-shadow 0.2s ease;
        }

        .request-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .request-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .request-detail {
            color: var(--muted);
            margin: 4px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-declined {
            background: #f8d7da;
            color: #721c24;
        }

        .action-row {
            margin-top: 14px;
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 10px 16px;
            font-weight: 600;
            border-radius: 10px;
            text-decoration: none;
            transition: background 0.25s ease;
            cursor: pointer;
            border: none;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .approve-btn { background: var(--success); }
        .approve-btn:hover { background: #2d8c3d; }

        .decline-btn { background: var(--danger); }
        .decline-btn:hover { background: #b43f3b; }

        .profile-btn {
            background: var(--primary);
        }
        .profile-btn:hover {
            background: var(--primary-dark);
        }

        .approve-btn {
            background: #d4edda;
            color: #155724;
        }
        .approve-btn:hover {
            background: #c3e6cb;
            color: #155724;
        }

        .decline-btn {
            background: #f8d7da;
            color: #721c24;
        }
        .decline-btn:hover {
            background: #f5c6cb;
            color: #721c24;
        }

        .approve-btn {
            background: #d4edda;
            color: #155724;
        }
        .approve-btn:hover {
            background: #c3e6cb;
            color: #155724;
        }

        .decline-btn {
            background: #f8d7da;
            color: #721c24;
        }
        .decline-btn:hover {
            background: #f5c6cb;
            color: #721c24;
        }

        .back-btn {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

<div class="header">
    <div class="header-title">Volunteer Requests</div>
</div>

<div class="container">

    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
        <a class="btn back-btn" href="/coordinator/dashboard/">‚Üê Back</a>
    </div>

    <div class="section">
        <h2 class="section-title">Pending Requests</h2>
        <div id="requestList"></div>
    </div>

</div>

<script>
    // Load all shift requests for the coordinator
    async function loadRequests() {
        try {
            const res = await fetch("/api/shift-requests/");
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const requests = await res.json();
            
            console.log('Fetched requests:', requests);

            const box = document.getElementById("requestList");
            box.innerHTML = "";

            if (!Array.isArray(requests)) {
                console.error('Response is not an array:', requests);
                box.innerHTML = "<p>Error: Invalid response format</p>";
                return;
            }

            if (requests.length === 0) {
                box.innerHTML = "<p>No pending requests at this time.</p>";
                return;
            }

            requests.forEach(req => {
                const div = document.createElement("div");
                div.className = "request-card";

            // Format the date
            const date = new Date(req.created_at);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Format shift date and time
            const shiftDate = new Date(req.shift_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Get status badge class
            const statusClass = `status-${req.status}`;

            // Build action buttons; disable when not pending
            const isPending = req.status === 'pending';
            const pendingAttrs = isPending ? '' : 'disabled aria-disabled="true" style="opacity:0.6; cursor:not-allowed;"';
            const actionButtons = `
                <button class="btn approve-btn" onclick="approveRequest(event, ${req.id})" ${pendingAttrs}>
                    Approve
                </button>

                <button class="btn decline-btn" onclick="declineRequest(event, ${req.id})" ${pendingAttrs}>
                    Decline
                </button>

                <a href="/coordinator/volunteers/${req.volunteer}/summary/" class="btn" style="background: #4A90E2; color: white; text-decoration: none; display: inline-block;">
                    View Profile
                </a>
            `;

            div.innerHTML = `
                <div class="request-header">${req.volunteer_name}</div>

                <div class="request-detail"><strong>Email:</strong> ${req.volunteer_email}</div>
                <div class="request-detail"><strong>Event:</strong> ${req.event_name}</div>
                <div class="request-detail"><strong>Shift Date:</strong> ${shiftDate}</div>
                <div class="request-detail"><strong>Shift Time:</strong> ${req.shift_start} - ${req.shift_end}</div>
                <div class="request-detail"><strong>Requested At:</strong> ${formattedDate}</div>

                <span class="status-badge ${statusClass}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span>

                <div class="action-row">
                    ${actionButtons}
                </div>
            `;

            box.appendChild(div);
        });
        } catch (error) {
            console.error('Error loading requests:', error);
            const box = document.getElementById("requestList");
            box.innerHTML = `<p>Error loading requests: ${error.message}</p>`;
        }
    }

    async function approveRequest(evt, requestId) {
        evt.stopPropagation();

        const note = prompt("Add a note (optional):", "");
        if (note === null) return; // User cancelled

        try {
            const res = await fetch(`/api/shift-requests/${requestId}/approve/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify({notes: note || ""})
            });

            if (res.ok) {
                await loadRequests();
            } else {
                alert("Error approving request");
            }
        } catch (error) {
            console.error("Error approving request:", error);
            alert("Error approving request: " + error.message);
        }
    }

    async function declineRequest(evt, requestId) {
        evt.stopPropagation();

        const note = prompt("Add a note (recommended for declining):", "");
        if (note === null) return; // User cancelled

        try {
            const res = await fetch(`/api/shift-requests/${requestId}/decline/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify({notes: note || ""})
            });

            if (res.ok) {
                await loadRequests();
            } else {
                alert("Error declining request");
            }
        } catch (error) {
            console.error("Error declining request:", error);
            alert("Error declining request: " + error.message);
        }
    }

    function getCookie(name) {
        let value = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    value = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return value;
    }

    loadRequests();
</script>

</body>
</html>
