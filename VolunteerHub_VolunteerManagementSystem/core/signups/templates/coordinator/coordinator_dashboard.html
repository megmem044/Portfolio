<!-- File: signups/templates/coordinator/coordinator_dashboard.html -->
<!-- Coordinator Dashboard — Blue Theme with event management focus -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coordinator Dashboard</title>
    {% include 'session_timeout.html' %}

    <style>
        :root {
            /* Blue palette to differentiate from volunteer pinks */
            --bg: #F0F8FF;
            --primary: #4A90E2;
            --primary-dark: #2E5C8A;
            --card: #FFFFFF;
            --text: #1F3A4D;
            --muted: #6B7C8F;
            --shadow: rgba(74, 144, 226, 0.15);
        }

        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 20px 26px;
            font-size: 20px;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
        }

        .nav-link {
            text-decoration: none;
            color: white;
            font-weight: 500;
            font-size: 15px;
            transition: opacity 0.2s ease;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        /* Body layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 22px;
        }

        .welcome-section {
            margin-bottom: 28px;
        }

        .welcome-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .welcome-text h1 {
            margin: 0 0 4px 0;
            font-size: 28px;
            color: var(--primary-dark);
        }

        .welcome-text p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .create-event-btn {
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.2s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .create-event-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Section title */
        .section-title {
            color: var(--primary-dark);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 18px;
            margin-top: 32px;
        }

        /* Events grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .event-card {
            background: var(--card);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }

        .event-card h3 {
            margin: 0 0 12px 0;
            color: var(--primary-dark);
            font-size: 16px;
            font-weight: 700;
        }

        .event-card p {
            margin: 6px 0;
            color: var(--muted);
            font-size: 13px;
        }

        .event-tags {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .tag {
            display: inline-block;
            background: #E8F1FF;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .event-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .event-btn {
            flex: 1;
            min-width: 90px;
            display: inline-block;
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .event-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
        }

        .create-event-section {
            background: var(--card);
            border-radius: 14px;
            padding: 28px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-top: 32px;
            display: none;
        }

        .create-event-section.show {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #D0D8E0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: var(--text);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-group textarea {
            grid-column: 1 / -1;
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 16px;
            grid-column: 1 / -1;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .time-inputs {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .time-inputs .form-group {
            flex: 1;
            margin: 0;
        }

        .time-inputs label {
            display: none;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.2s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #E8F1FF;
            color: var(--primary);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #D0E0FF;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: var(--primary);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s ease;
            border: none;
            cursor: pointer;
        }

        .back-btn:hover {
            background: var(--primary-dark);
            color: white;
        }
    </style>
</head>

<body>

<div class="header">
    <div class="header-left">
        <div>Coordinator Dashboard</div>
    </div>
    <div class="nav-menu">
        <a class="nav-link" href="/">Home</a>
        <a class="nav-link" href="/coordinator/signin/">Logout</a>
    </div>
</div>

<div class="container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-row">
            <div class="welcome-text">
                <h1>Welcome, {{ user.first_name|default:user.username }}</h1>
                <p>Manage events, volunteers, and track participation</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <a class="create-event-btn" href="javascript:toggleCreateForm()">Create New Event</a>
                <a class="create-event-btn" href="/coordinator/profile/" style="background: #6B7C8F;">Manage Profile</a>
            </div>
        </div>
    </div>

    <!-- Events List Section -->
    <div class="section-title">Your Events</div>
    <div class="events-grid" id="eventsGrid">
        <p style="color: var(--muted); grid-column: 1 / -1;">Loading events...</p>
    </div>

    <!-- Create Event Form Section -->
    <div class="create-event-section" id="createEventSection">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: var(--primary-dark);">Create Event</h2>
            <button type="button" class="btn btn-secondary" onclick="toggleCreateForm()">✕ Close</button>
        </div>
        
        <form id="createEventForm" method="POST" onsubmit="return false;">
            <div class="form-grid">
                <div class="form-group">
                    <label for="eventName">Name</label>
                    <input type="text" id="eventName" name="name" required>
                </div>

                <div class="form-group">
                    <label for="eventStartDate">Start Date</label>
                    <input type="date" id="eventStartDate" name="start_date" required>
                </div>

                <div class="form-group">
                    <label>Start Time</label>
                    <div class="time-inputs">
                        <div class="form-group">
                            <label for="eventStartHour">Hour</label>
                            <select id="eventStartHour" name="start_hour" required>
                                <option value="">HH</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventStartMinute">Minute</label>
                            <select id="eventStartMinute" name="start_minute" required>
                                <option value="">MM</option>
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventEndDate">End Date</label>
                    <input type="date" id="eventEndDate" name="end_date" required>
                </div>

                <div class="form-group">
                    <label>End Time</label>
                    <div class="time-inputs">
                        <div class="form-group">
                            <label for="eventEndHour">Hour</label>
                            <select id="eventEndHour" name="end_hour" required>
                                <option value="">HH</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventEndMinute">Minute</label>
                            <select id="eventEndMinute" name="end_minute" required>
                                <option value="">MM</option>
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventLocation">Location</label>
                    <input type="text" id="eventLocation" name="location" required>
                </div>

                <div class="form-group">
                    <label for="eventMax">Max Volunteers</label>
                    <input type="number" id="eventMax" name="max_volunteers" required>
                </div>

                <div class="form-group">
                    <label>Cultural Interests</label>
                    <div class="checkbox-group" id="culturalInterestsContainer">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventEnglishLevel">English Proficiency Level</label>
                    <select id="eventEnglishLevel" name="english_level">
                        <option value="">Select level</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Certificates Needed</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="certFirstAid" name="cert_first_aid">
                            <label for="certFirstAid">First Aid</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="certFoodSafety" name="cert_food_safety">
                            <label for="certFoodSafety">Food Safety</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventNotes">Notes</label>
                    <textarea id="eventNotes" name="notes" placeholder="Add any additional notes..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn">Create Event</button>
                <button type="reset" class="btn btn-secondary">Clear</button>
            </div>
        </form>
    </div>

</div>

<script>
    // Toggle event status (activate/deactivate)
    async function toggleEventStatus(eventId, currentStatus) {
        const newStatus = currentStatus === 'published' ? 'draft' : 'published';
        
        try {
            const res = await fetch(`/api/events/${eventId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.ok) {
                alert(`Event ${newStatus === 'published' ? 'activated' : 'deactivated'} successfully!`);
                loadEvents();
            } else {
                alert('Error updating event status');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating event status');
        }
    }

    // Delete event
    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event?')) {
            return;
        }
        
        try {
            const res = await fetch(`/api/events/${eventId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (res.ok) {
                alert('Event deleted successfully!');
                loadEvents();
            } else {
                alert('Error deleting event');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting event');
        }
    }

    // Fetch coordinator name and update the card
    async function fetchCoordinatorName(coordinatorId, eventId) {
        try {
            const res = await fetch(`/api/coordinators/${coordinatorId}/`);
            const coordinator = await res.json();
            const nameElement = document.getElementById(`coordinator-name-${eventId}`);
            if (nameElement) {
                nameElement.textContent = coordinator.name || 'Unknown';
            }
        } catch (error) {
            console.error('Error loading coordinator name:', error);
            const nameElement = document.getElementById(`coordinator-name-${eventId}`);
            if (nameElement) {
                nameElement.textContent = 'Unknown';
            }
        }
    }

    // Initialize time dropdowns with all 24 hours
    function initializeTimeDropdowns() {
        const hours = ['startHour', 'endHour'];
        
        hours.forEach(hourName => {
            const select = document.getElementById(`event${hourName.charAt(0).toUpperCase() + hourName.slice(1)}`);
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                select.appendChild(option);
            }
        });
    }

    // Toggle create form visibility
    function toggleCreateForm() {
        console.log('toggleCreateForm called');
        const section = document.getElementById('createEventSection');
        section.classList.toggle('show');
        if (section.classList.contains('show')) {
            section.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Load cultural categories
    async function loadCulturalCategories() {
        try {
            const res = await fetch('/api/interests/');
            const interests = await res.json();
            const container = document.getElementById('culturalInterestsContainer');
            container.innerHTML = ''; // Clear existing
            
            interests.forEach(interest => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'interest_' + interest.id;
                checkbox.name = 'cultural_interests';
                checkbox.value = interest.id;
                
                const label = document.createElement('label');
                label.htmlFor = 'interest_' + interest.id;
                label.textContent = interest.name;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                container.appendChild(checkboxItem);
            });
        } catch (error) {
            console.error('Error loading cultural categories:', error);
        }
    }

    // Load events
    async function loadEvents() {
        try {
            const res = await fetch('/api/events/');
            const events = await res.json();
            const grid = document.getElementById('eventsGrid');

            if (!events || events.length === 0) {
                grid.innerHTML = '<p style="color: var(--muted); grid-column: 1 / -1;">No events yet. Click "Create New Event" to get started!</p>';
                return;
            }

            grid.innerHTML = '';
            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'event-card';

                // Format creation date/time
                const createdDate = new Date(event.created_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const createdTime = new Date(event.created_at).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                });

                // Format start date/time
                const startDate = new Date(event.start_datetime).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const startTime = new Date(event.start_datetime).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                });

                // Format end date/time
                const endDate = new Date(event.end_datetime).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const endTime = new Date(event.end_datetime).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                });

                const tags = [];
                if (event.requires_first_aid) tags.push('First Aid');
                if (event.requires_food_safety) tags.push('Food Safety');

                card.innerHTML = `
                    <h3>${event.name}</h3>
                    <p><strong>Created:</strong> ${createdDate} at ${createdTime}</p>
                    <p><strong>Start:</strong> ${startDate}, ${startTime}</p>
                    <p><strong>End:</strong> ${endDate}, ${endTime}</p>
                    <p><strong>Location:</strong> ${event.location}</p>
                    <p><strong>Created by:</strong> <span id="coordinator-name-${event.id}">${event.coordinator_name || 'Loading...'}</span></p>
                    <p><strong>Max Volunteers:</strong> ${event.max_volunteers}</p>
                    <p><strong>Status:</strong> ${event.status}</p>
                    ${tags.length > 0 ? `<div class="event-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                    <div class="event-actions">
                        <a class="event-btn" href="/coordinator/events/${event.id}/manage/">Manage Event</a>
                        <a class="event-btn" href="/coordinator/events/${event.id}/edit/">Edit</a>
                        <button class="event-btn" onclick="toggleEventStatus(${event.id}, '${event.status}')">${event.status === 'published' ? 'Deactivate' : 'Activate'}</button>
                        <button class="event-btn" style="background: #E74C3C;" onclick="deleteEvent(${event.id})">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventsGrid').innerHTML = '<p style="color: var(--muted); grid-column: 1 / -1;">Error loading events.</p>';
        }
    }

    // Create event form
    async function handleCreateEventSubmit(e) {
        console.log('handleCreateEventSubmit called');
        e.preventDefault();
        
        try {
            const formData = new FormData(e.target);
            
            // Get date and time values
            const startDate = formData.get('start_date');
            const startHour = formData.get('start_hour');
            const startMinute = formData.get('start_minute');
            const endDate = formData.get('end_date');
            const endHour = formData.get('end_hour');
            const endMinute = formData.get('end_minute');
            
            console.log('Form values:', {startDate, startHour, startMinute, endDate, endHour, endMinute});
            
            const start_datetime = `${startDate}T${startHour}:${startMinute}:00`;
            const end_datetime = `${endDate}T${endHour}:${endMinute}:00`;
            
            const culturalInterests = Array.from(document.querySelectorAll('input[name="cultural_interests"]:checked')).map(cb => parseInt(cb.value));
            console.log('Selected cultural interests:', culturalInterests);
            
            const data = {
                name: formData.get('name'),
                start_datetime: start_datetime,
                end_datetime: end_datetime,
                location: formData.get('location'),
                max_volunteers: parseInt(formData.get('max_volunteers')),
                requires_first_aid: formData.get('cert_first_aid') === 'on',
                requires_food_safety: formData.get('cert_food_safety') === 'on',
                notes: formData.get('notes'),
                cultural_interests: culturalInterests,
            };

            console.log('Posting data:', JSON.stringify(data, null, 2));

            const res = await fetch('/api/events/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            });

            console.log('API response status:', res.status);
            
            if (res.ok) {
                alert('Event created successfully!');
                e.target.reset();
                toggleCreateForm();
                loadEvents();
            } else {
                const errorText = await res.text();
                console.error('Error response:', errorText);
                alert('Error creating event: ' + res.status + '\n' + errorText);
            }
        } catch (error) {
            console.error('Exception in handleCreateEventSubmit:', error);
            alert('Error creating event: ' + error.message);
        }
    }

    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        initializeTimeDropdowns();
        loadCulturalCategories();
        loadEvents();
        
        // Attach form submission handler after DOM is loaded
        const form = document.getElementById('createEventForm');
        if (form) {
            form.addEventListener('submit', handleCreateEventSubmit);
        }
    });
</script>

</body>
</html>
