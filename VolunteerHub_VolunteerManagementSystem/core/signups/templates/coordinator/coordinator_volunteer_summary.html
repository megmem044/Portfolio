<!-- File: signups/templates/coordinator/coordinator_volunteer_summary.html
     Purpose:
       Coordinator-facing volunteer summary page showing key volunteer information.
       Displays: Name, Email, Phone, Address, School, English Level, Cultural Interests.
       Uses the cerulean coordinator theme (blue palette).
       Provides a quick overview of volunteer details.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Volunteer Summary</title>

    <style>
        :root {
            /* Blue palette matching coordinator dashboard */
            --bg: #F0F8FF;
            --card: #FFFFFF;
            --primary: #4A90E2;
            --primary-dark: #2E5C8A;
            --text: #1F3A4D;
            --muted: #6B7C8F;
            --shadow: rgba(74, 144, 226, 0.15);
            --accent: #F5FAFF;
        }

        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            padding: 24px;
            font-size: 15px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 6px 20px var(--shadow);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 16px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            color: var(--primary-dark);
        }

        .back-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.25s ease;
        }

        .back-btn:hover {
            background: var(--primary-dark);
        }

        .summary-box {
            background: var(--accent);
            border: 1px solid #E0EFF5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 16px;
            align-items: flex-start;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: var(--primary-dark);
            width: 140px;
            flex-shrink: 0;
            font-size: 14px;
        }

        .info-value {
            color: var(--text);
            flex: 1;
            word-break: break-word;
        }

        .info-value.empty {
            color: var(--muted);
            font-style: italic;
        }

        .section-title {
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .volunteer-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
            border: none;
        }

        .loading {
            text-align: center;
            color: var(--muted);
            padding: 40px 20px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .photo-section {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            align-items: flex-start;
        }

        .photo-container {
            flex-shrink: 0;
        }

        .volunteer-photo {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            background: var(--accent);
            border: 2px solid var(--primary);
            object-fit: cover;
        }

        .certificate-section {
            margin-top: 24px;
        }

        .cert-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 12px;
        }

        .certificate-card {
            background: var(--accent);
            border: 1px solid #E0EFF5;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .cert-name-status {
            flex: 1;
        }

        .cert-name {
            font-weight: 600;
            color: var(--text);
            font-size: 15px;
            margin-bottom: 6px;
        }

        .cert-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: 600;
            border: none;
        }

        .cert-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .cert-status.approved {
            background: #d4edda;
            color: #155724;
        }

        .cert-status.declined {
            background: #f8d7da;
            color: #721c24;
        }

        .cert-file-section {
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid #D0E5F2;
        }

        .file-preview {
            background: white;
            border: 1px solid #D0E5F2;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            max-height: 300px;
            overflow: auto;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 280px;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
        }

        .file-preview.no-preview {
            text-align: center;
            color: var(--muted);
            font-size: 13px;
        }

        .cert-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .download-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.25s ease;
        }

        .download-btn:hover {
            background: var(--primary-dark);
            text-decoration: none;
        }

        .approve-btn, .reject-btn {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.25s ease;
        }

        .approve-btn {
            background: #d4edda;
            color: #155724;
        }

        .approve-btn:hover {
            background: #28a745;
            color: white;
        }

        .reject-btn {
            background: #f8d7da;
            color: #721c24;
        }

        .reject-btn:hover {
            background: #dc3545;
            color: white;
        }

        .no-certs {
            color: var(--muted);
            font-style: italic;
            font-size: 14px;
        }
    </style>
</head>

<body>
<div class="container">

    <div class="header">
        <h1>Volunteer Summary</h1>
        <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
    </div>

    <div id="errorMsg" class="error" style="display: none;"></div>

    <div id="loading" class="loading">Loading volunteer information...</div>

    <div id="content" style="display: none;">
        <div class="volunteer-name" id="volName">‚Äî</div>

        <div class="photo-section">
            <div class="photo-container">
                <img id="volPhoto" class="volunteer-photo" alt="Volunteer photo">
            </div>
        </div>
        
        <div class="summary-box">
            <div class="info-row">
                <div class="info-label">Email:</div>
                <div class="info-value" id="volEmail">‚Äî</div>
            </div>
            <div class="info-row">
                <div class="info-label">Phone:</div>
                <div class="info-value" id="volPhone">‚Äî</div>
            </div>
            <div class="info-row">
                <div class="info-label">Address:</div>
                <div class="info-value" id="volAddress">‚Äî</div>
            </div>
            <div class="info-row">
                <div class="info-label">School:</div>
                <div class="info-value" id="volSchool">‚Äî</div>
            </div>
            <div class="info-row">
                <div class="info-label">English Level:</div>
                <div class="info-value" id="volEnglish">‚Äî</div>
            </div>
            <div class="info-row">
                <div class="info-label">Cultural Interests:</div>
                <div class="info-value" id="volInterests">‚Äî</div>
            </div>
        </div>

        <div class="certificate-section">
            <div class="cert-title">Certificates</div>
            <div id="certificatesContainer">
                <div class="loading" style="padding: 20px; text-align: center; color: var(--muted);">Loading certificates...</div>
            </div>
        </div>
    </div>

</div>

<script>
    const volunteerId = "{{ volunteer_id }}";

    // SVG Avatar as a data URI (gray default avatar)
    const defaultAvatarSVG = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 120 120%22%3E%3Crect fill=%22%23E0EFF5%22 width=%22120%22 height=%22120%22/%3E%3Ccircle cx=%2260%22 cy=%2240%22 r=%2220%22 fill=%22%236B7C8F%22/%3E%3Cpath d=%22M30 100 Q30 70 60 70 Q90 70 90 100%22 fill=%22%236B7C8F%22/%3E%3C/svg%3E';

    async function loadVolunteerSummary() {
        try {
            if (!volunteerId) {
                throw new Error('No volunteer ID provided');
            }

            const res = await fetch(`/api/volunteers/${volunteerId}/`);
            if (!res.ok) {
                throw new Error(`Failed to load volunteer: HTTP ${res.status}`);
            }

            const volunteer = await res.json();

            // Display volunteer name
            document.getElementById("volName").textContent = volunteer.name || '‚Äî';

            // Display volunteer photo or avatar
            const photoImg = document.getElementById("volPhoto");
            if (volunteer.profile_image) {
                photoImg.src = volunteer.profile_image;
            } else {
                photoImg.src = defaultAvatarSVG;
            }

            // Display basic information
            document.getElementById("volEmail").textContent = volunteer.email || '‚Äî';
            document.getElementById("volPhone").textContent = volunteer.phone || '‚Äî';
            document.getElementById("volAddress").textContent = volunteer.address || '‚Äî';
            document.getElementById("volSchool").textContent = volunteer.school || '‚Äî';

            // Format English level
            const englishLevel = volunteer.english_level || '';
            if (englishLevel) {
                const formatted = englishLevel.charAt(0).toUpperCase() + englishLevel.slice(1);
                document.getElementById("volEnglish").textContent = formatted;
            } else {
                document.getElementById("volEnglish").textContent = '‚Äî';
            }

            // Format cultural interests
            if (volunteer.cultural_interests && volunteer.cultural_interests.length > 0) {
                const interests = volunteer.cultural_interests.map(interest => interest.name).join(', ');
                document.getElementById("volInterests").textContent = interests;
            } else {
                document.getElementById("volInterests").textContent = '‚Äî';
            }

            // Load certificates
            await loadCertificates();

            // Show content and hide loading
            document.getElementById("loading").style.display = 'none';
            document.getElementById("content").style.display = 'block';

        } catch (error) {
            console.error('Error loading volunteer summary:', error);
            document.getElementById("loading").style.display = 'none';
            document.getElementById("errorMsg").textContent = error.message;
            document.getElementById("errorMsg").style.display = 'block';
        }
    }

    async function loadCertificates() {
        try {
            const res = await fetch(`/api/certificates/?user=${volunteerId}`);
            if (!res.ok) {
                throw new Error(`Failed to load certificates: HTTP ${res.status}`);
            }

            const certificates = await res.json();
            const container = document.getElementById("certificatesContainer");

            // Filter for Food Safety and CPR certificates
            const relevantCerts = certificates.filter(cert => 
                cert.title && (
                    cert.title.toLowerCase().includes('food safety') ||
                    cert.title.toLowerCase().includes('cpor') ||
                    cert.title.toLowerCase().includes('cpr') ||
                    cert.title.toLowerCase().includes('first aid')
                )
            );

            if (relevantCerts.length === 0) {
                container.innerHTML = '<div class="no-certs">No certificates uploaded</div>';
                return;
            }

            let html = '';
            relevantCerts.forEach(cert => {
                const statusClass = cert.status ? cert.status.toLowerCase() : 'pending';
                // Capitalize first letter of status
                const rawStatus = cert.status || 'Pending';
                const statusText = rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1).toLowerCase();
                
                // Determine file preview and styling
                let filePreviewHTML = '';
                let isImageFile = false;
                let fileExt = '';
                
                if (cert.file) {
                    fileExt = cert.file.split('.').pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                        filePreviewHTML = `<img src="${cert.file}" alt="Certificate preview">`;
                        isImageFile = true;
                    } else if (fileExt === 'pdf') {
                        filePreviewHTML = `üìÑ PDF File - Click download to view`;
                    } else {
                        filePreviewHTML = `üìé File: ${cert.file.split('/').pop()}`;
                    }
                } else {
                    filePreviewHTML = 'No file uploaded';
                }

                html += `
                    <div class="certificate-card" data-cert-id="${cert.id}">
                        <div class="cert-header">
                            <div class="cert-name-status">
                                <div class="cert-name">${cert.title || 'Untitled Certificate'}</div>
                                <span class="cert-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="cert-file-section">
                            <div class="file-preview ${isImageFile ? '' : 'no-preview'}">
                                ${filePreviewHTML}
                            </div>
                            <div class="cert-actions">
                                ${cert.file ? `<a href="${cert.file}" class="download-btn" target="_blank" download>Download</a>` : ''}
                                ${statusClass === 'pending' ? `
                                    <button class="approve-btn" onclick="approveCertificate(${cert.id})">‚úì Approve</button>
                                    <button class="reject-btn" onclick="rejectCertificate(${cert.id})">‚úï Reject</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading certificates:', error);
            document.getElementById("certificatesContainer").innerHTML = '<div class="no-certs">Unable to load certificates</div>';
        }
    }

    async function approveCertificate(certId) {
        try {
            const res = await fetch(`/api/certificates/${certId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: 'approved' })
            });

            if (!res.ok) {
                throw new Error(`Failed to approve certificate: HTTP ${res.status}`);
            }

            // Reload certificates
            await loadCertificates();
            alert('Certificate approved successfully!');
        } catch (error) {
            console.error('Error approving certificate:', error);
            alert('Failed to approve certificate: ' + error.message);
        }
    }

    async function rejectCertificate(certId) {
        try {
            const res = await fetch(`/api/certificates/${certId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: 'declined' })
            });

            if (!res.ok) {
                throw new Error(`Failed to reject certificate: HTTP ${res.status}`);
            }

            // Reload certificates
            await loadCertificates();
            alert('Certificate rejected!');
        } catch (error) {
            console.error('Error rejecting certificate:', error);
            alert('Failed to reject certificate: ' + error.message);
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    loadVolunteerSummary();
</script>

</body>
</html>
